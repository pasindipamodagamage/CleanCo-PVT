// Utility function to decode JWT and get payload
function parseJwt(token) {
try {
const base64Url = token.split('.')[1];
const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
}).join(''));
return JSON.parse(jsonPayload);
} catch (error) {
console.error("Invalid token format", error);
return null;
}
}

// Role check function
function checkUserRole() {
const token = localStorage.getItem("authToken");

if (!token) {
alert("You are not logged in.");
window.location.href = "signIn.html";
return;
}

const decoded = parseJwt(token);
const userRole = decoded?.role;

if (!userRole) {
alert("Invalid token.");
return;
}

// Show/hide UI based on role
if (userRole === 'Customer') {
$('.buy-plan-btn').show();
$('#manage-categories').hide();
} else if (userRole !== 'Employee' && userRole !== 'Administrator') {
alert("You do not have permission.");
window.location.href = "signIn.html";
}
}

$(document).ready(function () {
checkUserRole();
});

$(document).on('click', '.buy-plan-btn', function () {
const categoryId = $(this).data('category-id');
$('#bookingCategoryId').val(categoryId);

const token = localStorage.getItem("authToken");
const decoded = token ? parseJwt(token) : null;

if (decoded && decoded.id) {
$('#bookingForm').data('user-id', decoded.id);
}

$('#bookingModal').modal('show');
});

document.getElementById('bookingForm')?.addEventListener('submit', function (e) {
e.preventDefault();

const categoryId = document.getElementById('bookingCategoryId').value;
const bookingDate = document.getElementById('bookingDate').value;
const userId = $('#bookingForm').data('user-id');

// Ensure the form is filled out correctly
if (!categoryId || !bookingDate) {
alert("Please select a valid date.");
return;
}

// Get current time for booking
const now = new Date();
const bookingTime = now.toTimeString().slice(0, 5); // Only the hour and minute

const bookingData = {
userId: userId,
categoryId: categoryId,
bookingDate: bookingDate,
bookingTime: bookingTime,
bookingStatus: "PENDING" // Ensure the booking status is set to "PENDING"
};

const token = localStorage.getItem("authToken");

// Perform AJAX request to save the booking
$.ajax({
url: 'http://localhost:8082/api/v1/booking/addBooking', // Endpoint to save the booking
type: 'POST',
contentType: 'application/json',
headers: {
"Authorization": "Bearer " + token // Include JWT token in the request headers
},
data: JSON.stringify(bookingData), // Send the booking data as a JSON payload
success: function (response) {
if (response.code === 200) {
alert("Booking submitted successfully! Pending Confirmation...");
// Optionally, you can redirect the user to a confirmation page or back to the dashboard
window.location.href = 'dashboard.html'; // Example: Redirect to dashboard after successful booking
} else {
alert("Booking failed: " + response.message);
}
},
error: function (xhr) {
console.error("Booking error:", xhr);
if (xhr.status === 403) {
alert("You are not authorized to make this booking.");
} else {
alert("Failed to submit booking. Please try again later.");
}
}
});
});



@PutMapping("/updatePaymentStatus/{bookingId}")
public ResponseEntity<String> updateBookingAfterPayment(@RequestHeader("Authorization") String authorization,
    @PathVariable("bookingId") UUID bookingId) {
    if (!hasRequiredRole(authorization, Role.Administrator, Role.Employee, Role.Customer)) {
    return ResponseEntity.status(VarList.Forbidden).body("Access denied: You do not have the required role.");
    }

    try {
    bookingService.updateBookingStatusAfterPayment(bookingId, null);
    return ResponseEntity.status(VarList.OK).body("Booking payment status updated");
    } catch (Exception e) {
    return ResponseEntity.status(VarList.Internal_Server_Error).body("Error: " + e.getMessage());
    }
    }

    @PutMapping("/confirmBooking/{bookingId}")
    public ResponseEntity<String> confirmBooking(@RequestHeader("Authorization") String authorization,
        @PathVariable("bookingId") UUID bookingId) {
        if (!hasRequiredRole(authorization, Role.Administrator, Role.Employee)) {
        return ResponseEntity.status(VarList.Forbidden).body("Access denied: You do not have the required role.");
        }

        try {
        bookingService.confirmBooking(bookingId);
        return ResponseEntity.status(VarList.OK).body("Booking confirmed");
        } catch (Exception e) {
        return ResponseEntity.status(VarList.Internal_Server_Error).body("Error: " + e.getMessage());
        }
        }

        @PutMapping("/rejectBooking/{bookingId}")
        public ResponseEntity<String> rejectBooking(@RequestHeader("Authorization") String authorization,
            @PathVariable("bookingId") UUID bookingId) {
            if (!hasRequiredRole(authorization, Role.Administrator, Role.Employee)) {
            return ResponseEntity.status(VarList.Forbidden).body("Access denied: You do not have the required role.");
            }

            try {
            bookingService.rejectBooking(bookingId);
            return ResponseEntity.status(VarList.OK).body("Booking rejected");
            } catch (Exception e) {
            return ResponseEntity.status(VarList.Internal_Server_Error).body("Error: " + e.getMessage());
            }
            }

            @PutMapping("/cancel/{bookingId}")
            public ResponseEntity<?> cancelBooking(@PathVariable UUID bookingId, HttpServletRequest request) {
            try {
            // Get the userId from the JWT token
            UUID userId = UUID.fromString((String) request.getAttribute("userId"));
            bookingService.cancelBooking(bookingId, userId);
            return ResponseEntity.ok(new ResponseUtil(VarList.OK, "Booking cancelled successfully", null));
            } catch (Exception e) {
            return ResponseEntity.badRequest().body(new ResponseUtil(VarList.Internal_Server_Error, e.getMessage(), null));
            }
            }

            @PutMapping("/completeBooking/{bookingId}")
            public ResponseEntity<String> completeBooking(@RequestHeader("Authorization") String authorization,
                @PathVariable("bookingId") UUID bookingId) {
                if (!hasRequiredRole(authorization, Role.Employee, Role.Administrator)) {
                return ResponseEntity.status(VarList.Forbidden).body("Access denied: You do not have the required role.");
                }

                try {
                bookingService.completeBooking(bookingId);
                return ResponseEntity.status(VarList.OK).body("Booking completed successfully");
                } catch (Exception e) {
                return ResponseEntity.status(VarList.Internal_Server_Error).body("Error: " + e.getMessage());
                }
                }

                @Override
                public void updateBookingStatusAfterPayment(UUID bookingId, PaymentDTO paymentDTO) {

                }

                @Override
                public void confirmBooking(UUID bookingId) throws Exception {
                Optional<Booking> bookingOptional = bookingRepo.findById(bookingId);
                    if (bookingOptional.isPresent()) {
                    Booking booking = bookingOptional.get();
                    booking.setBookingStatus(BookingStatus.CONFIRMED);
                    bookingRepo.save(booking);
                    } else {
                    throw new Exception("Booking not found");
                    }
                    }

                    @Override
                    public void rejectBooking(UUID bookingId) throws Exception {
                    Optional<Booking> bookingOptional = bookingRepo.findById(bookingId);
                        if (bookingOptional.isPresent()) {
                        Booking booking = bookingOptional.get();
                        booking.setBookingStatus(BookingStatus.REJECTED);
                        bookingRepo.save(booking);
                        } else {
                        throw new Exception("Booking not found");
                        }
                        }

                        @Override
                        public void cancelBooking(UUID bookingId, UUID userId) throws Exception {
                        Optional<Booking> bookingOptional = bookingRepo.findById(bookingId);
                            if (bookingOptional.isPresent()) {
                            Booking booking = bookingOptional.get();
                            // Check if the user trying to cancel the booking is the same as the user who made the booking
                            if (booking.getUser().getId().equals(userId)) {
                            booking.setBookingStatus(BookingStatus.CANCELLED);
                            bookingRepo.save(booking);
                            } else {
                            throw new Exception("User does not have permission to cancel this booking");
                            }
                            } else {
                            throw new Exception("Booking not found");
                            }
                            }

                            @Override
                            public void completeBooking(UUID bookingId) throws Exception {
                            Optional<Booking> bookingOptional = bookingRepo.findById(bookingId);
                                if (bookingOptional.isPresent()) {
                                Booking booking = bookingOptional.get();
                                // Update the booking status to COMPLETED
                                booking.setBookingStatus(BookingStatus.COMPLETED);
                                bookingRepo.save(booking);
                                } else {
                                throw new Exception("Booking not found");
                                }
                                }